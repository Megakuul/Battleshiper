AWSTemplateFormatVersion: "2010-09-09"
Resources:
    BuildJobDefinition:
        Properties:
            ContainerProperties:
                Command:
                    - /bin/sh
                    - -c
                    - echo "START BUILD $EXECUTION_IDENTIFIER" && mkdir -p out && cd out && git clone --branch $REPOSITORY_BRANCH $REPOSITORY_URL . && /bin/sh -c "$BUILD_COMMAND" && aws s3 cp $OUTPUT_DIRECTORY s3://$BUILD_ASSET_BUCKET_PATH/$EXECUTION_IDENTIFIER --recursive
                Environment:
                    - Name: BUILD_ASSET_BUCKET_PATH
                      Value: battleshiper-battleshiperpipelinebuildassetbucket-z0fnneh7lljv/example
                ExecutionRoleArn:
                    Fn::GetAtt:
                        - BuildJobExecRole
                        - Arn
                FargatePlatformConfiguration:
                    PlatformVersion: LATEST
                Image: megakuul/battleshiper-bun-builder:latest
                JobRoleArn:
                    Fn::GetAtt:
                        - BuildJobRole
                        - Arn
                LogConfiguration:
                    LogDriver: awslogs
                    Options:
                        awslogs-group: /battleshiper/project/build/example
                NetworkConfiguration:
                    AssignPublicIp: ENABLED
                ResourceRequirements:
                    - Type: MEMORY
                      Value: "1024"
                    - Type: VCPU
                      Value: "0.5"
                RuntimePlatform:
                    CpuArchitecture: X86_64
                    OperatingSystemFamily: LINUX
            JobDefinitionName: battleshiper-project-build-job-example
            PlatformCapabilities:
                - FARGATE
            Timeout:
                AttemptDurationSeconds: 600
            Type: container
        Type: AWS::Batch::JobDefinition
    BuildJobExecRole:
        Properties:
            AssumeRolePolicyDocument:
                Statement:
                    - Action: sts:AssumeRole
                      Effect: Allow
                      Principal:
                        Service: ecs-tasks.amazonaws.com
                Version: "2012-10-17"
            Description: role associated with aws batch, it is responsible to manage the running job
            Policies:
                - PolicyDocument:
                    Statement:
                        - Action:
                            - logs:CreateLogStream
                            - logs:PutLogEvents
                          Effect: Allow
                          Resource:
                            Fn::GetAtt:
                                - BuildLogGroup
                                - Arn
                    Version: "2012-10-17"
                  PolicyName: battleshiper-pipeline-build-log-example-exec-access
            Tags:
                - Key: battleshiper-project-build-job-exec-role-example
                  Value: Name
        Type: AWS::IAM::Role
    BuildJobRole:
        Properties:
            AssumeRolePolicyDocument:
                Statement:
                    - Action: sts:AssumeRole
                      Effect: Allow
                      Principal:
                        Service: ecs-tasks.amazonaws.com
                Version: "2012-10-17"
            Description: role associated with the actual project build job
            Policies:
                - PolicyDocument:
                    Statement:
                        - Action: s3:PutObject
                          Effect: Allow
                          Resource: arn:aws:s3:::battleshiper-battleshiperpipelinebuildassetbucket-z0fnneh7lljv/example/*
                    Version: "2012-10-17"
                  PolicyName: battleshiper-pipeline-build-asset-bucket-example-write-access
            Tags:
                - Key: battleshiper-project-build-job-role-example
                  Value: Name
        Type: AWS::IAM::Role
    BuildLogGroup:
        Properties:
            LogGroupName: /battleshiper/project/build/example
            RetentionInDays: 14
        Type: AWS::Logs::LogGroup
    BuildRule:
        Properties:
            Description: triggers the associated build targets
            EventBusName: battleshiper-pipeline-eventbus
            EventPattern:
                detail-type:
                    - battleshiper.build.example
                source:
                    - ch.megakuul.battleshiper
            Name: battleshiper-project-build-rule-example
            State: ENABLED
            Targets:
                - Arn: arn:aws:batch:eu-central-1:381492010367:job-queue/battleshiper-pipeline-build-queue
                  BatchParameters:
                    JobDefinition:
                        Ref: BuildJobDefinition
                    JobName: battleshiper-project-build-job-example
                  Id: battleshiper-project-build-queue
                  InputTransformer:
                    InputPathsMap:
                        TMPL_BUILD_COMMAND: $.detail.build_command
                        TMPL_DEPLOY_TICKET: $.detail.deploy_ticket
                        TMPL_EXECUTION_IDENTIFIER: $.detail.execution_identifier
                        TMPL_OUTPUT_DIRECTORY: $.detail.output_directory
                        TMPL_REPOSITORY_BRANCH: $.detail.repository_branch
                        TMPL_REPOSITORY_URL: $.detail.repository_url
                    InputTemplate: |
                        {"Parameters":{"deploy_ticket":"<TMPL_DEPLOY_TICKET>","execution_identifier":"<TMPL_EXECUTION_IDENTIFIER>"},"ContainerOverrides":{"Environment":[{"Name":"EXECUTION_IDENTIFIER","Value":"<TMPL_EXECUTION_IDENTIFIER>"},{"Name":"REPOSITORY_URL","Value":"<TMPL_REPOSITORY_URL>"},{"Name":"REPOSITORY_BRANCH","Value":"<TMPL_REPOSITORY_BRANCH>"},{"Name":"BUILD_COMMAND","Value":"<TMPL_BUILD_COMMAND>"},{"Name":"OUTPUT_DIRECTORY","Value":"<TMPL_OUTPUT_DIRECTORY>"}]}}
                  RetryPolicy:
                    MaximumEventAgeInSeconds: 150
                    MaximumRetryAttempts: 5
                  RoleArn:
                    Fn::GetAtt:
                        - BuildRuleRole
                        - Arn
        Type: AWS::Events::Rule
    BuildRuleRole:
        Properties:
            AssumeRolePolicyDocument:
                Statement:
                    - Action: sts:AssumeRole
                      Effect: Allow
                      Principal:
                        Service: events.amazonaws.com
                Version: "2012-10-17"
            Description: role to invoke the targets specified in the associated build rule
            Policies:
                - PolicyDocument:
                    Statement:
                        - Action: batch:SubmitJob
                          Effect: Allow
                          Resource:
                            - Ref: BuildJobDefinition
                            - arn:aws:batch:eu-central-1:381492010367:job-queue/battleshiper-pipeline-build-queue
                    Version: "2012-10-17"
                  PolicyName: battleshiper-pipeline-build-queue-example-exec-access
            Tags:
                - Key: battleshiper-project-build-rule-role-example
                  Value: Name
        Type: AWS::IAM::Role
    DeployLogGroup:
        Properties:
            LogGroupName: /battleshiper/project/deploy/example
            RetentionInDays: 14
        Type: AWS::Logs::LogGroup
    EventLogGroup:
        Properties:
            LogGroupName: /battleshiper/project/event/example
            RetentionInDays: 14
        Type: AWS::Logs::LogGroup
    ServerLogGroup:
        Properties:
            LogGroupName: /battleshiper/project/server/example
            RetentionInDays: 14
        Type: AWS::Logs::LogGroup
